let Peer=window.Peer,messagesEl=document.querySelector(".messages"),videoEl=document.querySelector(".remote-video"),myVideoEl=document.querySelector(".my-video"),button=document.querySelector(".button"),navigation=document.querySelectorAll(".navigation"),loaderSVG="<svg class=\"loader2\" width=\"32\" height=\"32\" viewBox=\"0 0 100 100\"><rect fill=\"white\" height=\"6\" opacity=\"0\" rx=\"3\" ry=\"3\" transform=\"rotate(-90 50 50)\" width=\"25\" x=\"72\" y=\"47\"></rect><rect fill=\"white\" height=\"6\" opacity=\"0.08333333333333333\" rx=\"3\" ry=\"3\" transform=\"rotate(-60 50 50)\" width=\"25\" x=\"72\" y=\"47\"></rect><rect fill=\"white\" height=\"6\" opacity=\"0.16666666666666666\" rx=\"3\" ry=\"3\" transform=\"rotate(-30 50 50)\" width=\"25\" x=\"72\" y=\"47\"></rect><rect fill=\"white\" height=\"6\" opacity=\"0.25\" rx=\"3\" ry=\"3\" transform=\"rotate(0 50 50)\" width=\"25\" x=\"72\" y=\"47\"></rect><rect fill=\"white\" height=\"6\" opacity=\"0.3333333333333333\" rx=\"3\" ry=\"3\" transform=\"rotate(30 50 50)\" width=\"25\" x=\"72\" y=\"47\"></rect><rect fill=\"white\" height=\"6\" opacity=\"0.4166666666666667\" rx=\"3\" ry=\"3\" transform=\"rotate(60 50 50)\" width=\"25\" x=\"72\" y=\"47\"></rect><rect fill=\"white\" height=\"6\" opacity=\"0.5\" rx=\"3\" ry=\"3\" transform=\"rotate(90 50 50)\" width=\"25\" x=\"72\" y=\"47\"></rect><rect fill=\"white\" height=\"6\" opacity=\"0.5833333333333334\" rx=\"3\" ry=\"3\" transform=\"rotate(120 50 50)\" width=\"25\" x=\"72\" y=\"47\"></rect><rect fill=\"white\" height=\"6\" opacity=\"0.6666666666666666\" rx=\"3\" ry=\"3\" transform=\"rotate(150 50 50)\" width=\"25\" x=\"72\" y=\"47\"></rect><rect fill=\"white\" height=\"6\" opacity=\"0.75\" rx=\"3\" ry=\"3\" transform=\"rotate(180 50 50)\" width=\"25\" x=\"72\" y=\"47\"></rect><rect fill=\"white\" height=\"6\" opacity=\"0.8333333333333334\" rx=\"3\" ry=\"3\" transform=\"rotate(210 50 50)\" width=\"25\" x=\"72\" y=\"47\"></rect><rect fill=\"white\" height=\"6\" opacity=\"0.9166666666666666\" rx=\"3\" ry=\"3\" transform=\"rotate(240 50 50)\" width=\"25\" x=\"72\" y=\"47\"></rect></svg>",logMessage=a=>{messagesEl.innerHTML="<div>"+a+"</div>"};window.logMessage=logMessage;let removeConnectionMessage=()=>{messagesEl.innerHTML=""},renderVideo=a=>{videoEl.srcObject=a,videoEl.onloadedmetadata=()=>{videoEl.play(),removeConnectionMessage()}},renderMyVideo=a=>{myVideoEl.srcObject=a,myVideoEl.onloadedmetadata=()=>{myVideoEl.play()}},peer=new Peer({config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:54.93.214.159:3478?transport=tcp",credential:"limor1",username:"user"}]}});logMessage(loaderSVG+"Connecting");let peerConn;peer.on("open",a=>{if(null==peerId)button.style.display="block",button.id=a,removeConnectionMessage();else{let a=peer.connect(peerId);peerConn=a,a.on("open",()=>{removeConnectionMessage()}),a.on("data",a=>{15>Math.sqrt(Math.pow(last_rot_data.alpha,2)-Math.pow(a.alpha,2))?rotateCamera(a):rotateCamera(last_rot_data),last_rot_data.alpha=a.alpha,last_rot_data.beta=a.beta,last_rot_data.gamma=a.gamma})}});var retryCount=0;peer.on("error",a=>{logMessage(loaderSVG+"Connecting"),3>retryCount?(retryCount++,peer.reconnect()):(peer.destroy(),logMessage("Meeting ended: "+a))}),peer.on("disconnected",function(){logMessage(loaderSVG+"Connecting"),3>retryCount?(retryCount++,peer.reconnect()):(peer.destroy(),logMessage("Meeting ended."))});let theadminConn,last_rot_data={alpha:0,beta:0,gamma:0};peer.on("connection",a=>{theadminConn=a,a.on("open",()=>{logMessage("Established connection with room participant"),removeConnectionMessage()}),a.on("data",a=>{if(null!=a.x){let b={x:a.x,y:a.y,z:a.z};createPoint(b)}else navigation[a].classList.add("visible"),window.setTimeout(()=>{navigation[a].classList.remove("visible")},2e3)})}),peer.on("call",a=>{logMessage(loaderSVG+"Connecting"),a.answer(myVideoStream),a.on("stream",a=>{renderMyVideo(a),removeConnectionMessage()}),a.on("error",a=>{logMessage(loaderSVG+"Connecting"),3>retryCount?(retryCount++,peer.reconnect()):(peer.destroy(),logMessage("Meeting ended: "+a))})});var myVideoStream,url=new URL(window.location.href),peerId=url.searchParams.get("room");null==peerId?(logMessage(loaderSVG+"Connecting"),document.title="Doorstep - Create Meeting",navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:!0}).then(a=>{myVideoStream=a,renderVideo(myVideoStream),videoEl.muted="muted",removeConnectionMessage()}).catch(()=>{removeConnectionMessage(),logMessage("Allow camera access for video chat.")})):(logMessage(loaderSVG+"Connecting"),myVideoEl.classList.add("big"),document.title="Doorstep - Join Meeting",navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then(a=>{let b=peer.call(peerId,a);b.on("stream",b=>{removeConnectionMessage(),renderMyVideo(a),renderVideo(b),myVideoEl.muted="muted",myVideoEl.classList.remove("big")}),b.on("error",a=>{myVideoEl.classList.add("big"),logMessage(loaderSVG+"Connecting"),3>retryCount?(retryCount++,peer.reconnect()):(peer.destroy(),logMessage("Meeting ended: "+a))})}).catch(()=>{removeConnectionMessage(),logMessage("Allow camera access for video chat.")}));let sendGyroData=a=>{theadminConn&&theadminConn.send(a)};window.sendGyroData=sendGyroData;let sendMarker=a=>{peerConn&&peerConn.send(a)};window.sendMarker=sendMarker;let sendNav=a=>{navigation[a].classList.add("visible"),window.setTimeout(()=>{navigation[a].classList.remove("visible")},2e3),peerConn&&peerConn.send(a)};window.sendNav=sendNav;let copy=a=>{var b=document.createElement("textarea");b.value=a,document.body.appendChild(b),b.focus(),b.select(),document.execCommand("copy"),document.body.removeChild(b)},copyLink=()=>{var a=window.location.href+"?room="+button.id;copy("Your package has arrived. Please direct it to your doorstep:\n"+a),button.innerHTML="Copied"};window.copyLink=copyLink;