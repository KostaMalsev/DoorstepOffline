let isMobile=window.matchMedia("only screen and (max-width: 760px)").matches;var url=new URL(window.location.href),peerId=url.searchParams.get("room"),DeviceOrientationController=function(a,b){this.object=a,this.element=b||document,this.freeze=!0,this.enableManualDrag=!0,this.enableManualZoom=!0,this.useQuaternions=!0,this.deviceOrientation={},this.screenOrientation=window.orientation||0;var c,d,e,f,g,h=0,i=0,j=0,k=0,l=new THREE.Quaternion,m=1,n=1,o=new THREE.Vector2,p=new THREE.Vector2,q={AUTO:0,MANUAL_ROTATE:1,MANUAL_ZOOM:2},r=q.AUTO,s={CALIBRATE_COMPASS:"compassneedscalibration",SCREEN_ORIENTATION:"orientationchange",MANUAL_CONTROL:"userinteraction",ZOOM_CONTROL:"zoom",ROTATE_CONTROL:"rotate"},t=window.innerHeight,u=2e3*Math.tan(THREE.Math.degToRad((this.object.fov||75)/2)),v=new THREE.Quaternion,w=function(){var a;return function(b){a=arguments||{},a.type=b,a.target=this,this.dispatchEvent(a)}.bind(this)}.bind(this)();this.constrainObjectFOV=function(){f=u*(window.innerHeight/t),g=THREE.Math.radToDeg(2*Math.atan(f/2e3)),this.object.fov=g}.bind(this),this.onDeviceOrientationChange=function(a){this.deviceOrientation=a}.bind(this),this.onScreenOrientationChange=function(){this.screenOrientation=window.orientation||0,w(s.SCREEN_ORIENTATION)}.bind(this),this.onCompassNeedsCalibration=function(a){a.preventDefault(),w(s.CALIBRATE_COMPASS)}.bind(this),this.onDocumentMouseDown=function(a){!0!==this.enableManualDrag||(a.preventDefault(),r=q.MANUAL_ROTATE,this.freeze=!0,l.copy(this.object.quaternion),h=j=a.pageX,i=k=a.pageY,c=.2*(1200/window.innerWidth),d=.2*(800/window.innerHeight),this.element.addEventListener("mousemove",this.onDocumentMouseMove,!1),this.element.addEventListener("mouseup",this.onDocumentMouseUp,!1),w(s.MANUAL_CONTROL+"start"),w(s.ROTATE_CONTROL+"start"))}.bind(this),this.onDocumentMouseMove=function(a){j=a.pageX,k=a.pageY}.bind(this),this.onDocumentMouseUp=function(){this.element.removeEventListener("mousemove",this.onDocumentMouseMove,!1),this.element.removeEventListener("mouseup",this.onDocumentMouseUp,!1),r=q.AUTO,this.freeze=!1,w(s.MANUAL_CONTROL+"end"),w(s.ROTATE_CONTROL+"end")}.bind(this),this.onDocumentTouchStart=function(a){switch(a.preventDefault(),a.stopPropagation(),a.touches.length){case 1:if(!0!==this.enableManualDrag)return;r=q.MANUAL_ROTATE,this.freeze=!0,l.copy(this.object.quaternion),h=j=a.touches[0].pageX,i=k=a.touches[0].pageY,c=.1*(1200/window.innerWidth),d=.1*(800/window.innerHeight),this.element.addEventListener("touchmove",this.onDocumentTouchMove,!1),this.element.addEventListener("touchend",this.onDocumentTouchEnd,!1),w(s.MANUAL_CONTROL+"start"),w(s.ROTATE_CONTROL+"start");break;case 2:if(!0!==this.enableManualZoom)return;r=q.MANUAL_ZOOM,this.freeze=!0,e=this.object.fov,o.set(a.touches[0].pageX,a.touches[0].pageY),p.set(a.touches[1].pageX,a.touches[1].pageY),m=n=o.distanceTo(p),this.element.addEventListener("touchmove",this.onDocumentTouchMove,!1),this.element.addEventListener("touchend",this.onDocumentTouchEnd,!1),w(s.MANUAL_CONTROL+"start"),w(s.ZOOM_CONTROL+"start");}}.bind(this),this.onDocumentTouchMove=function(a){switch(a.touches.length){case 1:j=a.touches[0].pageX,k=a.touches[0].pageY;break;case 2:o.set(a.touches[0].pageX,a.touches[0].pageY),p.set(a.touches[1].pageX,a.touches[1].pageY);}}.bind(this),this.onDocumentTouchEnd=function(){this.element.removeEventListener("touchmove",this.onDocumentTouchMove,!1),this.element.removeEventListener("touchend",this.onDocumentTouchEnd,!1),r===q.MANUAL_ROTATE?(r=q.AUTO,this.freeze=!1,w(s.MANUAL_CONTROL+"end"),w(s.ROTATE_CONTROL+"end")):r===q.MANUAL_ZOOM&&(this.constrainObjectFOV(),r=q.AUTO,this.freeze=!1,w(s.MANUAL_CONTROL+"end"),w(s.ZOOM_CONTROL+"end"))}.bind(this);var x=function(){var a=new THREE.Quaternion,b=new THREE.Euler,c=new THREE.Quaternion,d=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5)),e=0;return function(f,g,h,i){return b.set(g,f,-h,"YXZ"),a.setFromEuler(b),e=-i/2,c.set(0,Math.sin(e),0,Math.cos(e)),a.multiply(c),a.multiply(d),a}}(),y=function(){var a=new THREE.Matrix4,b=new THREE.Euler,c=new THREE.Euler,d=new THREE.Euler(-Math.PI/2,0,0,"YXZ"),e=new THREE.Matrix4,f=new THREE.Matrix4;return f.makeRotationFromEuler(d),function(d,g,h,i){return b.set(g,d,-h,"YXZ"),a.identity(),a.makeRotationFromEuler(b),c.set(0,-i,0,"YXZ"),e.identity(),e.makeRotationFromEuler(c),a.multiply(e),a.multiply(f),a}}();this.updateManualMove=function(){var a,b,f,g,s,t,u,w,x=new THREE.Euler(0,0,0,"YXZ"),y=new THREE.Quaternion,z=new THREE.Quaternion;return function(){z.copy(l),r===q.MANUAL_ROTATE?(a=(i-k)*d,b=(h-j)*c,f=THREE.Math.degToRad(a),g=THREE.Math.degToRad(b),y.set(0,Math.sin(g/2),0,Math.cos(g/2)),z.multiply(y),y.set(Math.sin(f/2),0,0,Math.cos(f/2)),z.multiply(y),s=x.setFromQuaternion(l,"YXZ").z,t=x.setFromQuaternion(z,"YXZ").z,u=x.setFromQuaternion(v||l,"YXZ").z,y.set(0,0,Math.sin((u-s)/2),Math.cos((u-s)/2)),l.multiply(y),y.set(0,0,Math.sin((u-t)/2),Math.cos((u-t)/2)),z.multiply(y),this.object.quaternion.copy(z)):r===q.MANUAL_ZOOM&&(n=o.distanceTo(p),w=m/n,w<=1&&(this.object.fov=e*w,this.object.updateProjectionMatrix()),v&&(s=x.setFromQuaternion(l,"YXZ").z,u=x.setFromQuaternion(v,"YXZ").z,y.set(0,0,Math.sin((u-s)/2),Math.cos((u-s)/2)),l.multiply(y),this.object.quaternion.copy(l)))}}(),this.UpdateRotFromNet=function(a){window.removeEventListener("resize",this.onDocumentMouseDown,!1),window.removeEventListener("resize",this.onDocumentTouchStart,!1),this.deviceOrientation.alpha=a.detail.alpha,this.deviceOrientation.beta=a.detail.beta,this.deviceOrientation.gamma=a.detail.gamma,this.updateDeviceMove()}.bind(this),this.updateDeviceMove=function(){var a,b,c,d,e;return function(){if(a=THREE.Math.degToRad(this.deviceOrientation.alpha||0),b=THREE.Math.degToRad(this.deviceOrientation.beta||0),c=THREE.Math.degToRad(this.deviceOrientation.gamma||0),d=THREE.Math.degToRad(this.screenOrientation||0),0!==a&&0!==b&&0!==c){if(this.useQuaternions?v=x(a,b,c,d):(e=y(a,b,c,d),v.setFromRotationMatrix(e)),this.freeze)return;this.object.quaternion.copy(v)}}}(),this.update=function(){this.updateDeviceMove(),r!==q.AUTO&&this.updateManualMove()},this.connect=function(){window.addEventListener("resize",this.constrainObjectFOV,!1),isMobile&&null==peerId&&(window.addEventListener("orientationchange",this.onScreenOrientationChange,!1),window.addEventListener("deviceorientation",this.onDeviceOrientationChange,!1)),window.addEventListener("compassneedscalibration",this.onCompassNeedsCalibration,!1),window.addEventListener("rotation-net-set",this.UpdateRotFromNet,!1),this.freeze=!1},this.disconnect=function(){this.freeze=!0,window.removeEventListener("resize",this.constrainObjectFOV,!1),window.removeEventListener("orientationchange",this.onScreenOrientationChange,!1),window.removeEventListener("deviceorientation",this.onDeviceOrientationChange,!1),window.removeEventListener("compassneedscalibration",this.onCompassNeedsCalibration,!1),this.element.removeEventListener("mousedown",this.onDocumentMouseDown,!1),this.element.removeEventListener("touchstart",this.onDocumentTouchStart,!1)}};DeviceOrientationController.prototype=Object.create(THREE.EventDispatcher.prototype);function updateRotationTo(a){window.dispatchEvent(new CustomEvent("rotation-net-set",{detail:{alpha:a.alpha,beta:a.beta,gamma:a.gamma}}))}var gwidth=375,gheight=375,scene=new THREE.Scene,camera=new THREE.PerspectiveCamera(60,375/gheight,.1,1e3);camera.position.set(0,0,.1);var renderer=new THREE.WebGLRenderer({alpha:!0});renderer.setSize(375,gheight),document.body.appendChild(renderer.domElement),renderer.domElement.style.position="fixed",renderer.domElement.style.top=0,renderer.domElement.style.left=0,renderer.domElement.style.zIndex=2;const scene2=new THREE.Scene;scene2.add(camera);var cssRenderer=new CSS2DRenderer;cssRenderer.setSize(375,gheight),cssRenderer.domElement.style.position="fixed",cssRenderer.domElement.style.top=0,cssRenderer.domElement.style.left=0,cssRenderer.domElement.style.cursor="pointer",cssRenderer.domElement.style.zIndex=3,document.body.appendChild(cssRenderer.domElement);var normal=new THREE.Vector3(0,0,-1),center=new THREE.Vector3,plane=new THREE.Plane().setFromNormalAndCoplanarPoint(normal,center),planeGeometry=new THREE.PlaneGeometry(0,0),coplanarPoint=plane.coplanarPoint(),focalPoint=new THREE.Vector3().copy(coplanarPoint).add(plane.normal);planeGeometry.lookAt(focalPoint),planeGeometry.translate(coplanarPoint.x,coplanarPoint.y,coplanarPoint.z);const material1=new THREE.MeshBasicMaterial({color:0,alphaTest:0,visible:!1}),mesh=new THREE.Mesh(new THREE.PlaneGeometry(window.innerWidth,window.innerHeight),material1);mesh.rotation.x=0,mesh.position.y=0,mesh.position.z=-10,mesh.position.x=0;let pivot_=new THREE.Object3D;pivot_.position.z=0,camera.add(mesh),camera.add(pivot_),scene.add(camera);var DevControls=new DeviceOrientationController(camera,cssRenderer.domElement);DevControls.connect(),window.addEventListener("resize",resize);var raycaster=new THREE.Raycaster,mouse=new THREE.Vector2,tempRadius=new THREE.Vector3;function setMouse(a){mouse.x=2*(a.mouseX/gwidth)-1,mouse.y=2*-(a.mouseY/gheight)+1}function setRaycaster(a){setMouse(a),raycaster.setFromCamera(mouse,camera)}function clickedOnScreen(a){setRaycaster(a);var b=raycaster.intersectObjects(scene.children,!0);if(0<b.length){let a={x:b[0].point.x,y:b[0].point.y,z:b[0].point.z};createPoint(a),sendMarker(a)}}function createPoint(a){var b=document.createElement("div");b.classList="marker";var c=new CSS2DObject(b);scene2.add(c),c.position.x=a.x,c.position.y=a.y,c.position.z=a.z,setTimeout(()=>{scene2.remove(c)},15e3)}var currentX,initialX,xOffset=0,active=!1,click=!1,swiped=!1,direction=0;cssRenderer.domElement.addEventListener("touchstart",dragStart,!1),cssRenderer.domElement.addEventListener("touchend",dragEnd,!1),cssRenderer.domElement.addEventListener("touchmove",drag,!1),cssRenderer.domElement.addEventListener("mousedown",dragStart,!1),cssRenderer.domElement.addEventListener("mouseup",dragEnd,!1),cssRenderer.domElement.addEventListener("mousemove",drag,!1);function dragStart(a){initialX="touchstart"===a.type?a.touches[0].clientX-xOffset:a.clientX-xOffset,active=!0,click=!0,swiped=!1}function dragEnd(a){xOffset=0;var b={};"touchend"===a.type?(b.mouseX=a.touches[0].clientX,b.mouseY=a.touches[0].clientY):(b.mouseX=a.clientX,b.mouseY=a.clientY),!0==click&&clickedOnScreen(b),active=!1}function drag(a){active&&(a.preventDefault(),currentX="touchmove"===a.type?a.touches[0].clientX-initialX:a.clientX-initialX,xOffset=currentX,direction=0>xOffset?-1:1,30>Math.abs(xOffset)&&(direction=0),1==direction&&!1==swiped?(sendNav(0),swiped=!0):-1==direction&&!1==swiped&&(sendNav(1),swiped=!0),click=!1)}function resize(){}function render(){requestAnimationFrame(render),renderer.render(scene,camera),cssRenderer.render(scene2,camera),DevControls.update()}render();function rotateCamera(a){updateRotationTo(a)}var orientationGranted=!1;function requestPermission(){"function"==typeof DeviceOrientationEvent.requestPermission&&DeviceOrientationEvent.requestPermission().then(a=>{"granted"===a&&(orientationGranted=!0,window.addEventListener("deviceorientation",()=>{}))}).catch(console.error)}window.addEventListener("deviceorientation",function(a){var b=null!=a&&null!=a.alpha&&null!=a.beta&&null!=a.gamma;if(b){orientationGranted=!0;var c={alpha:a.alpha.toFixed(2),beta:a.beta.toFixed(2),gamma:a.gamma.toFixed(2)};sendGyroData(c)}});var url=new URL(window.location.href),peerId=url.searchParams.get("room");let promptEl=document.querySelector(".prompt-wrapper");!1==orientationGranted&&null==peerId&&promptEl.classList.add("visible");function copy(a){var b=document.createElement("textarea");b.value=a,document.body.appendChild(b),b.focus(),b.select(),document.execCommand("copy"),document.body.removeChild(b)}function copyLink(){var a=window.location.href+"?room="+document.querySelector(".button").id;copy("Your package has arrived. Please direct it to your doorstep:\n"+a),document.querySelector(".button").innerHTML="Copied"}document.querySelector(".button").addEventListener("click",()=>{copyLink()}),document.querySelectorAll(".buttons div")[0].addEventListener("click",()=>{promptEl.classList.remove("visible")}),document.querySelectorAll(".buttons div")[1].addEventListener("click",()=>{promptEl.classList.remove("visible"),requestPermission()});