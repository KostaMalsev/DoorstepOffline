<!DOCTYPE html>
<html>
<head>
    <title>Loocat</title>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css' rel='stylesheet'/>
    <link rel="stylesheet" href="styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="icon" href="icon.png">
    <meta property="og:image" content="https://www.berryscript.com/getaround.png">
    <meta name="description" content="View this place with Loocat.">
</head>


<body>

<div class="title">
    <div style="position:relative">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1 1" stroke-linecap="round" width="100%" height="100%">
            <path d="M0.637,0.283c0,0 -0.079,-0.072 -0.193,-0.066c-0.217,0.014 -0.283,0.304 -0.181,0.466c0.089,0.137 0.354,0.175 0.425,0c0.007,-0.021 0.012,-0.045 0.013,-0.067c0.001,-0.006 0.006,-0.089 -0.069,-0.094c-0.054,-0.004 -0.092,0.061 -0.092,0.061"
                  fill="none" stroke="#fff" stroke-width="0.11px"></path>
        </svg>
        <div class="spinner">
            <div class="spinner-blade"></div>
            <div class="spinner-blade"></div>
            <div class="spinner-blade"></div>
            <div class="spinner-blade"></div>
            <div class="spinner-blade"></div>
            <div class="spinner-blade"></div>
            <div class="spinner-blade"></div>
            <div class="spinner-blade"></div>
            <div class="spinner-blade"></div>
            <div class="spinner-blade"></div>
            <div class="spinner-blade"></div>
            <div class="spinner-blade"></div>
        </div>
        <a></a>
    </div>
</div>

<div class="alert">
    <img src="https://lh3.googleusercontent.com/2n3kx7T5vXvpt6enkx19fxruOzptjKyHIHK72TK0MNYTCWThcDUrdsIClJ8wZo_M8-fXUwEIH6LXq9N7eJQi1xCqPGomn9Jf0DRV_Rc">
    <a>Low GPS. Showing approximate location</a>
</div>

<!--Mapbox component-->
<div class="map">
    <svg xmlns="http://www.w3.org/2000/svg" height="55" viewBox="0 0 24 24" width="55"
         onclick="this.parentElement.classList.toggle('open')" fill="white" class="compass">
        <path d="M0 0h24v24H0z" fill="none"></path>
        <path d="M12 10.9c-.61 0-1.1.49-1.1 1.1s.49 1.1 1.1 1.1c.61 0 1.1-.49 1.1-1.1s-.49-1.1-1.1-1.1zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm2.19 12.19L6 18l3.81-8.19L18 6l-3.81 8.19z"></path>
    </svg>
    <div class="search-wrapper">
        <!--Search input box:-->
        <input class="search" placeholder="Search..." spellcheck="false">
    </div>
    <div id='map' style='width: 100vw; height: 100vh;'></div>
</div>

<!-- Dialog for marker placement:-->
<div class="prompt-wrapper">
    <div class="overlay" onclick="this.parentElement.classList.remove('open')"></div>
    <div class="prompt">
        <span contenteditable="" class="rename"></span>
        <div class="buttons" onclick="this.parentElement.parentElement.classList.remove('open')">
            <div class="button">Cancel</div>
            <div class="button" onclick="renameMarker()">Add</div>
        </div>
    </div>
</div>


<div class="debug-button" onclick="this.classList.toggle('open')"></div>

<div class="debug">
    <p id="Movement">Location: </p>

    <a id="GPSloc"></a> <a id="Pos"></a> <a id="Speed"></a>

    <!--<p id="Rotation">Rotation: </p>-->

    <!--<a id="Compass"></a> -->
    <a id="RotationWrapper"></a>

    <p id="IOSEvent">IOS rot event: </p>
    <p id="AndroidEvent">Android rot event: </p>
    <p id="STATS"> Status </p>

    <p id="PlacesLoaded">Places</p>
    <p id="LOCESTERR">LOCESTERR</p>
    <p id="ERRMSG">ERR MSG</p>
    <p id="GEOLINK">Geo Link</p>

    <div class="theButton" onclick="copy(document.querySelector('#GEOLINK').innerText)">Copy Geolink</div>
    <div class="theButton" onclick="addPlane()">Show plane</div>
    <div class="theButton" onclick="ClearAllMarkers()">Clear Markers</div>
</div>


<video id="webcam" class="background" playsinline crossorigin="anonymous"></video>
<!--<div class="over" style="width: 100vw;position: fixed;z-index: -999;left: 0;top: 0;background: rgba(0,0,0,0.2);height: 100vh;-webkit-backdrop-filter:saturate(180%) blur(20px)">-->

<div id="RotPerm" class="theButton" onclick="onClick();this.style.display='none'">Rotation Permission</div>
<!--<div class="theButton" style="top: 50px" onclick="activateLocation();this.style.display='none'">Location Permission</div>-->

<div class="arrow top">
  <svg viewBox="0 0 30 30" width="30" height="30"> <path fill="currentColor" d="M19.214 21.212L12.865 15l6.35-6.35-1.933-1.932L9 15l8.282 8.282 1.932-2.07z"></path> </svg>
</div>

<div class="arrow-wrapper">
    <div class="arrow">
        <svg viewBox="0 0 30 30" width="30" height="30"> <path fill="currentColor" d="M19.214 21.212L12.865 15l6.35-6.35-1.933-1.932L9 15l8.282 8.282 1.932-2.07z"></path> </svg>
    </div>
</div>

<!--<canvas id="c"></canvas>-->

<!--<script src="https://threejs.org/build/three.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/101/three.min.js"></script>
<!--Map box support:-->
<script src='https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js'></script>

<!-- Firebase support: -->
<!--<script src="https://www.gstatic.com/firebasejs/7.23.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.23.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.23.0/firebase-database.js"></script>
-->

<!--<script src='https://raw.githubusercontent.com/mrdoob/three.js/master/examples/js/renderers/CSS3DRenderer.js'></script>-->
<script src='./DeviceOrientationController.js'></script>
<script src='./GenericFuncs.js'></script>
<!-- <script src='./CSS3DRenderer.js'></script> -->
<script src='./CSS2DRenderer.js'></script>
<script src='./MotionHelper.js'></script>
<script src='./RotationHelper.js'></script>
<script src='./VrEnvironment.js'></script>
<script src='./FirebaseHelper.js'></script>
<script src='./StorageHelper.js'></script>
<script src="mapboxHelper.js"></script>

<!-- </script>type="module"> -->
<script>

    //Create texture loader and scene:
    const loader = new THREE.TextureLoader();
    const scene = new THREE.Scene();

    //Create the camera wrapper - he will be aligned  to north and moved by GPS:
    const CameraWrapper = new THREE.Object3D();
    CameraWrapper.position.set(0, 0, 0.01 );

    //Define perspective camera:
    //const camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
    const camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 100000 );
    camera.position.set(0, 0, 0 );

    //Set camera as camera wrapper child:
    CameraWrapper.add(camera);
    scene.add(CameraWrapper);

    //Add laser for pointing to objects
    let laser = new THREE.Object3D();
    camera.add(laser);


    //Create Renderer:
    const renderer = new THREE.WebGLRenderer( { alpha: true } );
    renderer.setSize( window.innerWidth, window.innerHeight );
    renderer.setPixelRatio( window.devicePixelRatio );
    renderer.domElement.style.position = 'absolute';
    renderer.domElement.style.top = 0;
    document.body.appendChild( renderer.domElement);


    //Create texture plane:
    const material1 = new THREE.MeshBasicMaterial({
        map: loader.load('./border.png'),
    });
    const planeGeo = new THREE.PlaneGeometry( 500, 500, 1000 );
    const mesh = new THREE.Mesh(planeGeo, material1);
    mesh.rotation.x = Math.PI * -.5;
    mesh.position.y = -10;
    mesh.position.z = -10;
    function addPlane() {
      scene.add(mesh);
    }
    //for debug:
    var el  = document.getElementById('LOCESTERR');
    var dir = 0;


    //Create css scene:
    const scene2 = new THREE.Scene();
    scene2.add(CameraWrapper);

    //The current target object, arrows points it's direction
    var TargetObjectGlob=null;

    //Create CSS2D renderer:
    var cssRenderer = new CSS2DRenderer();
    cssRenderer.setSize( window.innerWidth, window.innerHeight );
    cssRenderer.domElement.style.position = 'absolute';
    cssRenderer.domElement.style.top = 0;
    document.body.appendChild( cssRenderer.domElement );

    //Create device binded controls:
    var DevControls = new DeviceOrientationController( camera, renderer.domElement );
    DevControls.connect();


    //Animate function for rendering:
    const animate = function () {
      //Check if marker in FOV of camera
      dir = CheckInFOV(camera, TargetObjectGlob, el);
      changeArrow(dir);
      //Hide direction arrows if no markers:
      if(GlobMarkersList.length==0) changeArrow(0);

      //Update player position to next_pos - is updated from GPS
      UpdateCameraPos(next_pos);

      DevControls.update();
      requestAnimationFrame(animate);

      renderer.render(scene, camera);
      cssRenderer.render(scene2, camera);
    };

    //Call animate recurring function:
    animate();


    // Create Stream video
    try {
        navigator.mediaDevices.getUserMedia({
            video: {
                width: {
                    min: 1280,
                    ideal: 1920,
                    max: 2560,
                },
                height: {
                    min: 720,
                    ideal: 1080,
                    max: 1440,
                },
                facingMode: "environment"
            },
        }).then(stream => {
            let $video = document.querySelector('video');
            $video.srcObject = stream;
            $video.onloadedmetadata = () => {
                $video.play();
            }
        });
    }
    catch(e) {}

    //Determine the invocation method:
    InvokeAppOrigin = GetInvocationMethod();

    //Start Sequence of initialization:
    //Initialize location module
    InitMovement();

    //Init the rotation module:
    InitRot();


    //Init virtual environment:
    InitVR();

    //Mapbox init:
    MapboxInit();

    //Initialize Firebase connection:
    //InitFirebase();

    //Set listeners for Local Storage:
    InitStorage();

    //Dedetects if page was suspended:
    var lastFired = new Date().getTime();
    var now=0;
    setInterval(function() {
        now = new Date().getTime();
        if((now - lastFired) > 1000) {//if it's been more than 1 second
            //alert("onfocus");
            //Awaken from  suspension:
            //Set z axis to north
            InitRot();
            document.getElementById("ERRMSG").innerHTML = `Awake from suspention ${(new Date()).toLocaleTimeString()}`;
        }
        lastFired = now;
    }, 100); //interval of 100 ml sec


</script>

</body>
</html>
